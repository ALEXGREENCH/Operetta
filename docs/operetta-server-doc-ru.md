# Документация сервера Operetta

## Обзор
Operetta — реализованный на Go серверный аналог прокси Opera Mini 1.x–3.x, ориентированный на модифицированный клиент версии 2.06. Сервер принимает устаревшие POST-запросы Opera Mini, загружает исходный HTML и формирует поток OMS/OBML v2, который понимает клиент. В документе описаны архитектура сервера, формат OBML и особенности обмена между Opera Mini и Operetta.

## Структура репозитория
- `README.md` — Краткое описание проекта и перечень реализованных возможностей.
- `PROTOCOL.txt` — Комментированный пример POST-запроса Opera Mini и бинарного ответа OMS.
- `main.go` — Точка входа HTTP: регистрирует обработчики (`/`, `/fetch`, `/validate`, `/ping`), разбирает нагрузку Opera Mini, управляет кэшированием и пагинацией и вызывает рендерер `oms`.
- `url.go` — Вспомогательные функции для нормализации URL, обработки закладок, формирования ключей кэша и построения запросов.
- `oms/oms.go` — Основной движок рендеринга: загрузка и декодирование HTML, эвристическая поддержка CSS, обход DOM, генерация тегов OBML, обработка изображений, пагинация и финализация OMS.
- `config/sites/` — Настройки для отдельных доменов в `*.json` (`mode`, `headers`); путь можно переопределить переменной `OMS_SITES_DIR`.
- `docs/` — Справочные заметки (`OBML.md`, `oms_protocol.md`) и подробное руководство.
- `dist/`, `build.ps1`, `build.sh`, `Makefile` — Сборочные артефакты и вспомогательные скрипты.

## Архитектура выполнения
1. `main()` считывает флаг `-addr` или переменную `PORT`, настраивает логирование, формирует HTTP-маршрутизатор через `newServer()` и запускает `net/http.Server`.
2. Маршрутизатор направляет POST-запросы Opera Mini в `rootHandler`, ручные запросы `/fetch` — в `fetchHandler`, диагностику — в `validateHandler`, а проверку живости — в `pingHandler`.
3. `rootHandler` разбирает нуль-разделённые пары ключ/значение (`parseNullKV`), нормализует URL (`normalizeObmlURL`), формирует `oms.RenderOptions` из подсказок клиента (`k`, `d`, `j`, токены аутентификации) и вызывает `loadWithSiteConfig`.
4. `loadWithSiteConfig` объединяет переопределения для сайтов, выбирает между `oms.LoadPageWithHeadersAndOptions` и `oms.LoadCompactPageWithHeaders` и передаёт управление рендереру, который возвращает `*oms.Page`.
5. Обработчик устанавливает заголовки ответа (`Content-Type: application/octet-stream`, явный `Content-Length`, `Connection: close`), пишет краткий дамп OMS через `dumpOMS`, добавляет куки из `page.SetCookies` и отдаёт упакованный бинарный поток клиенту.

## Рукопожатие Opera Mini
Opera Mini 2.x отправляет `Content-Type: application/xml`, хотя тело — это список пар `key=value`, разделённых нулевыми байтами. Operetta принимает их как есть, учитывает характеристики устройства и возвращает токены аутентификации Opera в ответе.

```text
POST / HTTP/1.1
Host: 192.168.0.3:8008
Content-Type: application/xml
...
k=image/jpeg\x00
o=280\x00
u=/obml/http://operamini.com/\x00
q=ru\x00
v=Opera Mini/2.0.4509/hifi/woodland/ru\x00
i=Opera/8.01 (J2ME/MIDP; Opera Mini/2.0.4509/1630; ru; U; ssr)\x00
...
j=opf=1&q=Yukaba&btnG=Search+in+Google
```

| Ключ | Описание |
| --- | --- |
| `k` | Предпочитаемый MIME-тип изображений (`image/jpeg` и т. п.). |
| `o` | Версионный идентификатор шлюза (OM 2.x — 280, OM 3.x — 285). |
| `u` | Запрошенный ресурс (обычно `/obml/<схема>/<URL>`); сервер преобразует его в абсолютный URL. |
| `q` | Код локализации интерфейса. |
| `v` | Строка версии клиента Opera Mini. |
| `i` | Эквивалентная User-Agent строка настольного браузера. |
| `s` | Индикатор сеанса (как правило `-1`). |
| `n` | Счётчик запроса / номер страницы. |
| `A` | Уровень профиля CLDC (например, `CLDC-1.1`). |
| `B` | Уровень профиля MIDP (`MIDP-2.0`). |
| `C` | Идентификатор устройства (модель/прошивка). |
| `D` | Код языка интерфейса устройства. |
| `E` | Предпочитаемая кодировка символов (например, `ISO-8859-1`). |
| `d` | Блок характеристик (`w` ширина, `h` высота, `c` глубина цвета, `m` объём памяти JVM, `i` изображения, `q` качество, `f/j/l` флаги). |
| `c` | Код аутентификации (хэш), которым Opera проверяет ответ. |
| `h` | Префикс аутентификации в паре с `c`. |
| `f` | Referrer, переданный клиентом. |
| `g` | Флаг режима шлюза (`1` включает полный прокси-режим). |
| `b` | Метка модификации клиента (например, `mod2.06`). |
| `y` | Дополнительный языковой код (предпочтение контента). |
| `t` | Переключатель автодетекции телефонных номеров (`0` отключает). |
| `w` | Индикатор многостраничного ответа `partCurrent;isLast`. |
| `e` | Подсказка по сжатию: `def` (deflate) или `none`. |
| `j` | URL-кодированное тело формы при отправке. |

**Ответ.** Operetta возвращает `HTTP/1.1 200 OK`, устанавливает `Content-Type: application/octet-stream`, всегда передаёт `Content-Length` и закрывает соединение — так требует стек MIDP. Тело — упакованный OMS, описанный ниже.

## HTTP-эндпоинты
- `POST /` — Основная точка входа Opera Mini: обрабатывает рукопожатие, внутренние страницы `server:`, локальные закладки и генерацию OBML.
- `GET /fetch` — Диагностический/ручной эндпоинт; повторяет поведение прокси для заданного URL и принимает параметры `url`, `action`, `get`, `ua`, `lang`, `img`, `hq`, `mime`, `maxkb`, `pp`, `page`.
- `GET /validate` — Дважды загружает страницу (полный и компактный режимы), нормализует результаты и отдаёт JSON с метриками `analyzeOMS`.
- `GET /ping` — Лёгкая проверка доступности (`pong`).

## Конвейер рендеринга
- **Загрузка и подготовка запроса.** `LoadPageWithHeadersAndOptions` / `LoadCompactPageWithHeaders` формируют HTTP-запрос, применяют переопределённые заголовки, прокидывают куки и referer, переключаются на POST при `RenderOptions.FormBody` и запрашивают только gzip.
- **Работа с кодировками.** `decodeLegacyToUTF8` анализирует `Content-Type` и `<meta charset>`, конвертируя Windows-1251 и KOI8-R в UTF-8 до разбора.
- **Построение таблиц стилей.** `buildStylesheet` собирает встроенные `<style>` и до трёх внешних таблиц, нормализует базовые CSS-свойства и передаёт их в `computeStyleFor`.
- **Обход DOM.** Рекурсивный `walkRich` скрывает невидимые элементы, распознаёт структуру (`p`, заголовки, списки, `hr`/`br`), добавляет теги OBML и выделяет заголовки с помощью `AddPlus` и стилевых флагов.
- **Текст и стили.** Текстовые узлы превращаются в теги `T`; `walkState` ведёт стек стилевых битов (`styleBoldBit`, `styleItalicBit`, `styleUnderBit`, `styleCenterBit`, `styleRightBit`) и генерирует `S` при изменении стиля.
- **Формы и элементы.** Поддерживаются `<form>` (`h`), `<input>` (`x`, `p`, `i`, `u`, `b`, `e`, `c`, `r`), `<select>` (`s`, `o`, `l`), значения по умолчанию и переданные данные отображаются через `RenderOptions.FormBody`.
- **Изображения.** `fetchAndEncodeImage` учитывает `RenderOptions.ImagesOn`, использует оперативный и дисковый LRU-кэш (`OMS_IMG_CACHE_DIR`, `OMS_IMG_CACHE_MB`), конвертирует в JPEG/PNG, масштабирует `golang.org/x/image/draw` и генерирует `I`; при ограничениях выдаёт `J`.
- **Пагинация и навигация.** `RenderOptions.MaxTagsPerPage` (по умолчанию `OMS_PAGINATE_TAGS`) делит поток тегов через `splitByTags`; навигационные блоки добавляются при известном `RenderOptions.ServerBase`. Полные snapshots сохраняются в `Page.CachePacked` и используются `SelectOMSPartFromPacked`.
- **Финализация и нормализация.** `Page.finalize()` добавляет `Q`, вычисляет счётчики тегов/строк (можно настроить `OMS_TAGCOUNT_MODE`, `OMS_TAGCOUNT_DELTA`), записывает заголовок V2, выполняет deflate и добавляет транспортный заголовок. `NormalizeOMS` и `NormalizeOMSWithStag` стабилизируют счётчики (например, `stag_count = 0x0400`).
- **Эхо-аутентификация и куки.** Рендерер дублирует `AuthCode`/`AuthPrefix` в теги `k`, сохраняет `Set-Cookie` источника и передаёт их через `page.SetCookies` в HTTP-ответ.

## Детали формата OBML / OMS
- **Транспортный заголовок.** Ответ начинается с 6 байт: little-endian `0x3218` и big-endian длины (заголовок + сжатое тело).
- **Заголовок V2.** Сжатое тело открывается 35-байтным заголовком V2 с «перевёрнутыми» `TagCount`, `PartCurrent`, `PartCount`, `StagCount` и `Cachable=0xFFFF`; счётчик включает завершающий `Q`.
- **Строки и кодировки.** Строки — это длина (big-endian) + UTF-8; первая строка — канонический URL (например, `1/http://...`).
- **Цвета и стили.** Цвета кодируются в BGR565 (`calcColor`), стили — в 32-битных масках. `AddBgcolor`, `AddTextcolor` и `AddStyle` создают `R`, `D`, `S`.
- **Совместимость.** Реализация ориентирована на OMS/OBML v2 (Opera Mini 2.x); более поздние форматы v12–v16 с chunk-структурами и ARGB не поддерживаются.

| Тег | Полезная нагрузка | Назначение |
| --- | --- | --- |
| `+` | нет | Разделитель блоков и заголовков. |
| `B` | нет | Перенос строки (`<br>`). |
| `V` | нет | Разделитель абзацев (`<p>`). |
| `T` | длина + UTF-8 | Текстовый узел. |
| `L` | длина + URL | Начало ссылки; закрывается `E`. |
| `E` | нет | Конец ссылки. |
| `R` | 2 байта цвета | Горизонтальная линия / цвет фона. |
| `S` | 4 байта маски | Смена стиля (жирный, курсив, подчёркнутый, выравнивание). |
| `D` | 2 байта цвета | Изменение цвета текста. |
| `I` | ширина, высота, длина данных, резерв, данные | Встроенное изображение (JPEG/PNG). |
| `J` | ширина, высота | Заглушка изображения. |
| `k` | тип + строка | Аутентификационные данные (`0` — префикс, `1` — код). |
| `h` | две строки | Заголовок формы (action и метод). |
| `x` | байт настроек + две строки | Текстовое поле (имя, значение). |
| `p` | две строки | Поле пароля. |
| `i` | две строки | Скрытое поле. |
| `u` | две строки | Кнопка отправки. |
| `b` | две строки | Обычная кнопка. |
| `e` | две строки | Кнопка сброса. |
| `c` | две строки + флаг | Флажок (имя, значение, состояние). |
| `r` | две строки + флаг | Радиокнопка. |
| `s` | строка + флаги | Начало списка `<select>` (имя, multiple, число опций). |
| `o` | две строки + флаг | Опция (значение, подпись, выбранность). |
| `l` | нет | Конец `<select>` (для совместимости). |
| `Q` | нет | Маркер конца потока. |

## Кэширование, пагинация и эхо
- **Кэш страниц.** `pageCache` (`sync.Map`) хранит упакованные OMS-ответы с ключом по URL и настройкам рендеринга (`cacheKey`), позволяя `/fetch` отдавать следующие страницы через `cacheSelect` без повторной загрузки.
- **SelectOMSPartFromPacked.** Распаковывает сохранённый ответ, делит его по лимиту тегов и возвращает нужный фрагмент, обновляя номера частей; при ошибке используется исходный поток.
- **Прокидывание кук.** Заголовки `Set-Cookie` источника сохраняются в `page.SetCookies`; обработчики добавляют их в HTTP-ответ, чтобы клиент сохранил куки.
- **Токены аутентификации.** `RenderOptions.AuthCode` и `AuthPrefix` дублируются тегами `k`, чтобы клиент принимал поток.

## Конфигурация и переменные окружения

| Переменная | Описание |
| --- | --- |
| `PORT` | Переопределяет порт прослушивания (иначе используется `-addr`, по умолчанию `:8080`). |
| `OMS_BOOKMARKS_MODE` | Управляет fallback для `/obml/`: `remote`/`pass` проксируют opera-mini.ru, иное выдаёт локальный список. |
| `OMS_BOOKMARKS` | Список закладок `name|url`, разделённых запятыми, для локальной страницы. |
| `OMS_SITES_DIR` | Собственный каталог с JSON-настройками для хостов. |
| `OMS_IMG_CACHE_DIR` | Путь к дисковому кэшу изображений. |
| `OMS_IMG_CACHE_MB` | Лимит памяти/диска для кэша изображений (по умолчанию 200 МБ). |
| `OMS_IMG_DEBUG` | При `1` логируются ошибки скачивания/конвертации изображений. |
| `OMS_TAGCOUNT_MODE` | Стратегия подсчёта тегов (`exact`, `exclude_q`, `plus1`, `plus2`). |
| `OMS_TAGCOUNT_DELTA` | Числовое значение, добавляемое к подсчитанному числу тегов. |
| `OMS_PAGINATE_TAGS` | Лимит тегов на часть при включённой пагинации. |

`/fetch` понимает параметры `img`, `hq`, `mime`, `maxkb`, `pp`, `page`, `ua`, `lang`, которые напрямую заполняют `RenderOptions`. Файлы JSON поддерживают `{"mode":"full|compact","headers":{...}}`.

## Отладка и инструменты
- **Лог-дубли.** `dumpOMS` выводит магию, длину и крайние байты OMS для каждого ответа.
- **Валидатор.** `/validate?url=...` строит полный и компактный варианты, запускает `analyzeOMS` и возвращает JSON со счётчиками тегов/строк и данными пагинации.
- **Вспомогательная форма.** Страница `GET /` отдаёт HTML-форму (`indexHTML`) для ручного тестирования без Opera Mini.
- **Трассировка изображений.** `OMS_IMG_DEBUG=1` включает логирование попаданий/промахов кэша и ошибок конвертации изображений.

## Совместимость и ограничения
- **CSS.** Поддерживается только ограниченное подмножество CSS (display, цвет, фон, простые inline-стили); сложные раскладки, float и media-запросы игнорируются.
- **Формы.** Метод GET поддерживается полностью; POST проксируется при наличии `RenderOptions.FormBody`, однако multipart и загрузка файлов не реализованы.
- **Изображения.** Крупные изображения заменяются заглушками в зависимости от `MaxInlineKB`; форматы за пределами JPEG/PNG (например, анимированный GIF, неподдерживаемый WebP) удаляются.
- **Покрытие OBML.** Теги вне набора OM 2.x (мультимедиа, расширенные шрифты) не генерируются; клиентам с OBML v6+ требуется отдельная адаптация.
- **Транспорт.** Ответы всегда отправляются как неподфрагментированный HTTP/1.1 с `Connection: close`; поддержка HTTPS зависит от внешнего терминирования (reverse proxy, stunnel).

## Дополнительные материалы
- **`docs/OBML.md`** — Подробный разбор структуры тегов, пагинации и транспортного заголовка.
- **`docs/oms_protocol.md`** — Справочник по протоколу на базе старых исходников C/Java.
- **Community OBML spec** — [grawity/obml-parser – obml-format.md](https://github.com/grawity/obml-parser/blob/master/obml-format.md) для сравнения с более поздними версиями OBML.
